<!DOCTYPE html>
<html lang="en">
  
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>The elegance of lazy sequences in Clojure &middot; Tinkering</title>
    <meta name="description" content="Come for the Foo, stay for the Bar" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#aa0000">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <link rel="alternate" type="application/atom+xml" title="RSS" href="https://drafts--tinkering.netlify.app/atom.xml">

    <style>html,body{background:#fffaf7;color:#2d2d2d;font:18px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"}a,a:visited{color:darkred;text-decoration:none}a:hover{text-decoration:underline}main{margin:auto;max-width:65ch;padding:0.8rem}pre{background:white;overflow:scroll;padding:1rem}td{border:1px solid #2d2d2d;padding:10px}img{height:auto;max-width:100%}.homepage-list{list-style:none;padding:1rem 0}.homepage-list li{align-items:center;display:flex;flex-wrap:wrap;justify-content:space-between;margin-bottom:10px}@media (max-width: 65ch){.homepage-list li a{width:100%}}code{font-size:90%}p>code,li>code{padding:.15em .25em;color:#bf616a;background-color:#e8e8e8;border-radius:3px}
</style>

    <meta property="og:site_name" content="Tinkering">
      <meta name="author" content="Zach Mitchell" />
      <meta property="og:title" content="The elegance of lazy sequences in Clojure">
      <meta property="og:description" content="">
      <meta property="og:url" content="https://drafts--tinkering.netlify.app/clojure-lazy-sequences/">
      <meta property="og:image" content="">

      <meta property="og:type" content="article" />
        <meta property="article:published_time" content="2021-03-25T00:00:00+00:00" />

      <link rel="prev" href="https://drafts--tinkering.netlify.app/python-function-vs-method/" />
      <link rel="next" href="https://drafts--tinkering.netlify.app/optimization-story/" />
    

  </head>
  

  <body>
    <main id="main" role="main">

      
      <header role="banner">
        <h3 style="margin-top:0;">
          <a href="https://drafts--tinkering.netlify.app" title="Home">Tinkering</a>
          <br /><small>Come for the Foo, stay for the Bar</small>
        </h3>
      </header>
      <hr />
      

      
<article>
  <h1>The elegance of lazy sequences in Clojure</h1>

  
  <p style="font-size:90%;">Posted on <time datetime=" 2021-03-25T00:00:00+00:00">March 25, 2021</time></p>
  

  
  <div style="font-size:90%;">
    <p>Table of Contents:</p>
    <ul>
      
      <li>
        <a href="https://drafts--tinkering.netlify.app/clojure-lazy-sequences/#outline">Outline</a>
        
      </li>
      
    </ul>
  </div>
  

  <h2 id="outline">Outline</h2>
<ul>
<li>Setting the scene
<ul>
<li>When you see this example, what do you see?
<ul>
<li>Example that would take a really long time with eager sequences.</li>
</ul>
</li>
<li>Why doesn't this take a really long time?</li>
<li>The example uses lazy sequences.</li>
</ul>
</li>
<li>Why am I talking about this
<ul>
<li>Many examples just slap <code>lazy-seq</code> on the front of a form and it just works.</li>
<li>You see a lot of examples that use <code>lazy-seq</code> in conjunction with <code>cons</code>. Why is that?</li>
<li>I want to demystify lazy sequences for new Clojure users.</li>
<li>The underlying code is surprisingly simple.</li>
</ul>
</li>
<li>When are lazy sequences used?
<ul>
<li>Pretty frequently
<ul>
<li>ex.) <code>map</code>, when passed a function and a collection</li>
</ul>
</li>
</ul>
</li>
<li>Introducing the model system
<ul>
<li>The <code>iterate</code> function
<ul>
<li><code>(iterate f x)</code></li>
<li>Returns a lazy sequence of <code>x</code>, <code>f(x)</code>, <code>f(f(x))</code>, ...</li>
</ul>
</li>
<li>The actual implementation is in Java.
<ul>
<li>clojure/jvm/lang/Iterate.java</li>
</ul>
</li>
<li>Let's look at a Clojure implementation.
<ul>
<li><code>(defn iterate [fn val] (cons val (lazy-seq (iterate fn (fn val)))))</code></li>
<li>Notice that it uses a <code>cons</code> cell and recursion.
<ul>
<li>This seems important, but I'm too tired to formulate why.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>What does <code>lazy-seq</code> do?
<ul>
<li>Clojure implementation
<ul>
<li>https://github.com/clojure/clojure/blob/38bafca9e76cd6625d8dce5fb6d16b87845c8b9d/src/clj/clojure/core.clj#L683</li>
<li><code>(defmacro lazy-seq [&amp; body] (list 'new 'clojure.lang.LazySeq (list* '^{:once true} fn* [] body)))</code></li>
<li>Creates a list of the form:
<ul>
<li><code>(new clojure.lang.LazySeq (fn* [] body))</code>
<ul>
<li><code>list*</code> treats its last argument as a sequence and prepends the other arguments to it.</li>
</ul>
</li>
</ul>
</li>
<li>What is <code>fn*</code>?
<ul>
<li>https://github.com/clojure/clojure/blob/38bafca9e76cd6625d8dce5fb6d16b87845c8b9d/src/clj/clojure/core.clj#L4513</li>
<li>It's used to define a &quot;function expression&quot;
<ul>
<li>You can see that here:
<ul>
<li>https://github.com/clojure/clojure/blob/38bafca9e76cd6625d8dce5fb6d16b87845c8b9d/src/jvm/clojure/lang/Compiler.java#L7104</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>This list is basically an anonymous function whose body is the expression passed to <code>lazy-seq</code>.</li>
<li>So this list <code>(new ...)</code> calls the <code>LazySeq</code> constructor with an anonymous function whose body is the expression passed to <code>lazy-seq</code>.</li>
</ul>
</li>
<li>If we back up, what does our <code>iterate</code> function look like?
<ul>
<li><code>(defn iterate [&amp; body] (cons value &lt;LazySeq object&gt;))</code></li>
</ul>
</li>
</ul>
</li>
</ul>

</article>


      
      <footer role="contentinfo">
        <hr />
        
        <nav style="margin-bottom:1rem;" role="navigation">
          
            <a href="/">Home</a>
            
              <span>&middot;</span>
            
          
            <a href="https://github.com/zmitchell">GitHub</a>
            
              <span>&middot;</span>
            
          
            <a href="/about/">About</a>
            
          
        </nav>
        
        
        <small>
          
          
        </small>
        
      </footer>
      

    </main>
    
    
  </body>
</html>

